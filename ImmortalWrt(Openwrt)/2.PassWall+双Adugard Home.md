[参考视频](https://www.youtube.com/watch?v=0kCSJL_lSyw)

# 配置PassWall
+ 参考[PassWall  Xray 自动分流 + HAProxy 负载均衡](https://www.youtube.com/watch?v=hgdnaB6l_nQ)，使用Cloudflare CND加速可使用[优选IP脚本](https://github.com/yonggekkk/Cloudflare-vless-trojan).
+ 基本设置>DNS，关闭DNS重定向
****

# OpenWrt安装第一个adguardhome插件
## 1 安装插件
### 1.1 SSH连接后命令安装
```shell
opkg update
opkg install adguardhome
```
### 1.2 或者在管理面板的系统>软件包中，点击更新列表，在过滤器中筛选AdguardHome后安装
******

## 2 修改软路由DNS端口，后续让AdguardHome监听
+ 网络>DHCP/DNS>常规，关闭DNS重定向
+ 网络>DHCP/DNS>设置及端口，DNS服务器端口改为553
****

## 3 配置第一个AdguardHome
### 3.1 输入192.168.XX.XX:3000[^1]访问管理界面，若无法访问可使用AI排查问题，参考AI给我的启动命令：
```shell
nohup /usr/bin/AdGuardHome -c /etc/adguardhome.yaml -w /var/adguardhome --no-check-update >/dev/null 2>&1 &
```

### 3.2 配置端口
+ **网络管理界面**
	+ **监听接口**：所有接口
	+ **端口**：3000
+ **DNS服务器**
	+ **监听接口**：所有接口
	+ **端口**：53

### 3.3 身份认证
+ 输入用户名和密码，后续用于登录

### 3.4 DNS设置
+  设置>DNS设置
+ **上游DNS服务器**：127.0.0.1:553[^2]
+ **DNS服务配置**：
	+ **速度限制**：0
+ **DNS缓存配置**：
	+ **缓存大小**：
	+ **覆盖最小TTL值**：
	+ **覆盖最大 TTL 值**：

### 3.5 广告拦截
+ 过滤器>DNS 黑名单
+ 添加黑名单
+ 添加一个自定义列表
+ 名称：AdBlock DNS Filters
+ URL：https://gcore.jsdelivr.net/gh/217heidai/adblockfilters@main/rules/adblockdns.txt
+ 检查更新

****

## OpenWrt安装第二个adguardhome插件

## 1 创建桥接网络
```shell
docker network create --subnet=172.18.10.0/24 --gateway 172.18.10.1 MyNET
```
## 2 部署docker
```shell
docker run -d --name AdGuard-Home1 -v /opt/docker/AGH_Docker1:/opt/adguardhome/work -v /opt/docker/AGH_Docker1:/opt/adguardhome/conf -p 3001:3000 --restart always --net MyNET --ip 172.18.10.2 adguard/adguardhome:latest
```
+ 如果拉取镜像时出现 operation not supported 的报错，可能是固件不支持直接安装，提供一个用AI重写的镜像 ![[adguard_clean.tar] 
+ 使用 docker load -i /docker/adguard_clean.tar[^镜像存储路径]拉取本地镜像
+ 镜像存在缺陷，使用下面的命令部署
```shell
docker run -d --name AdGuard-Home1 \
  -v /opt/docker/AGH_Docker1/conf:/opt/adguardhome/conf \
  -v /opt/docker/AGH_Docker1/work:/opt/adguardhome/work \
  -p 3001:3000 --restart always \
  --net MyNET --ip 172.18.10.2 \
  --entrypoint /opt/adguardhome/AdGuardHome/AdGuardHome \
  my-adguard:clean \
  -w /opt/adguardhome/work -c /opt/adguardhome/conf/AdGuardHome.yaml --no-check-update
```

## 3 配置桥接网络
+ OpenWrt>网络>防火墙>常规设置>区域，docker这一行点击编辑
+ 常规设置，允许转发到目标区域：lan wan wan6
+ 高级设置，涵盖的设备：选择新建的桥接网络(docker0和br-lan以外的那一个)

## 4 输入192.168.XX.XX:3001[^1]访问管理界面

## 5 配置端口
+ **网络管理界面**
	+ **监听接口**：所有接口
	+ **端口**：3000[^docker的内部端口]
+ **DNS服务器**
	+ **监听接口**：所有接口
	+ **端口**：53
 

## 6 身份认证
+ 输入用户名和密码，后续用于登录

## 7 DNS设置
+ **注意配置完后改成3001端口访问**
+  设置>DNS设置
+ **上游DNS服务器**：
	+ 如果是子路由，填写上一级路由的DNS地址
	+ 如果是拨号路由，填写运营商提供的DNS，在OpenWrt>概览>网络>IPv4上游 中查看DNS1和DNS2
+ **DNS服务配置**：
	+ **速度限制**：0
+ **DNS缓存配置**：
	+ **缓存大小**：16777216
	+ **覆盖最小TTL值**：600
	+ **覆盖最大 TTL 值**：3600
	+ **乐观缓存**：Y

### 3.5 去除广告拦截
+ 过滤器>DNS 黑名单，取消所有条目的勾选

# PassWall设置直连DNS
+ 基本设置>DNS，直连 DNS：172.18.10.2

[^1]: 软路由地址

[^2]: 与2.2设置的端口一致，如果有服务因为DNS缓存出现问题，可以在这里添加对特定域名指定的上游DNS(示例：[/baidu.com/]180.76.76.76)
