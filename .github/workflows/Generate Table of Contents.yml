name: Generate Table of Contents

on:
  workflow_dispatch:
  schedule:
    # 每天北京时间 05:00 (UTC 21:00)
    - cron: '0 21 * * *'

jobs:
  update-toc:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Create Python Script
        run: |
          cat << 'EOF' > update_toc.py
          import os
          import re

          def get_tree(path, prefix=''):
              # === 配置排除列表 ===
              # 在这里添加了 '附件'
              exclude = {
                  '.git', '.github', 'images', 'assets', 'node_modules', 
                  '.vscode', 'venv', '附件'
              }
              
              try:
                  items = sorted(os.listdir(path))
              except Exception as e:
                  print(f"Error reading {path}: {e}")
                  return []

              valid_items = []
              for item in items:
                  # 1. 排除在黑名单中的名称 (如 '附件')
                  # 2. 排除以 . 开头的文件/文件夹
                  if item in exclude or item.startswith('.'):
                      continue
                  
                  full_path = os.path.join(path, item)
                  
                  # === 核心筛选逻辑 ===
                  # 如果是文件夹：保留
                  if os.path.isdir(full_path):
                      valid_items.append(item)
                  # 如果是文件：只要不是 README.md 就保留 (不再限制 .md 后缀，所以 test.txt 会显示)
                  elif os.path.isfile(full_path) and item.lower() != 'readme.md':
                      valid_items.append(item)

              tree_lines = []
              for i, item in enumerate(valid_items):
                  is_last = (i == len(valid_items) - 1)
                  connector = '└── ' if is_last else '├── '
                  
                  full_path = os.path.join(path, item)
                  if os.path.isdir(full_path):
                      tree_lines.append(f'{prefix}{connector}{item}/')
                      new_prefix = prefix + ('    ' if is_last else '│   ')
                      tree_lines.extend(get_tree(full_path, new_prefix))
                  else:
                      tree_lines.append(f'{prefix}{connector}{item}')
              return tree_lines

          # 生成目录数据
          print("Generating tree...")
          tree_data = ['notes/'] + get_tree('.')
          
          # 使用反引号包裹生成 Markdown 代码块
          toc_content = '```\n' + '\n'.join(tree_data) + '\n```'
          
          readme_path = 'README.md'
          start_marker = '<!-- TOC_START -->'
          end_marker = '<!-- TOC_END -->'
          
          # 正则匹配标记 (忽略大小写和空格)
          regex_start = re.compile(r'<!--\s*TOC_START\s*-->', re.IGNORECASE)

          if os.path.exists(readme_path):
              with open(readme_path, 'r', encoding='utf-8') as f:
                  content = f.read()

              match = regex_start.search(content)
              if match:
                  # 保留标记前的所有内容（标题/简介）
                  header = content[:match.start()].strip()
                  # 防止头部为空
                  if not header:
                      header = '# Notes'
                  
                  # 拼接：Header + 标记 + 目录树 + 结束标记
                  # (标记后的所有旧内容会被自动截断/丢弃)
                  final_content = f'{header}\n\n{start_marker}\n{toc_content}\n{end_marker}\n'
                  print('Success: Updated README and preserved header.')
              else:
                  # 没找到标记，追加到文件末尾
                  final_content = content.strip() + f'\n\n{start_marker}\n{toc_content}\n{end_marker}\n'
                  print('Success: Appended TOC to README.')

              with open(readme_path, 'w', encoding='utf-8') as f:
                  f.write(final_content)
          else:
              # README 不存在，创建新文件
              with open(readme_path, 'w', encoding='utf-8') as f:
                  f.write(f'# Notes\n\n{start_marker}\n{toc_content}\n{end_marker}\n')
              print('Success: Created new README.')
          EOF

      - name: Execute Script
        run: python3 update_toc.py

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: update directory tree (show all files, ignore '附件') [skip ci]"
            git push
          fi
