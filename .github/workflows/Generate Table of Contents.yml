name: Generate Table of Contents

on:
  push:
    paths:
      - '**/*.md'
      - README.md
  pull_request:
    paths:
      - '**/*.md'
      - README.md
  workflow_dispatch:  # 支持手动触发

jobs:
  generate-toc:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Generate Table of Contents for README.md
      run: |
        #!/bin/bash
        README_FILE="README.md"

        TOC_PLACEHOLDER="<!-- TOC -->"
        if ! grep -q "$TOC_PLACEHOLDER" "$README_FILE"; then
          echo "$TOC_PLACEHOLDER" >> "$README_FILE"
        fi

        # 生成 TOC（忽略以 . 开头和 “附件” 文件夹内）
        TOC_LINES=()
        while IFS= read -r line; do
          HEADER_TEXT=$(echo "$line" | sed -E 's/^(#{1,6})\s(.*)/\2/')
          ANCHOR=$(echo "$HEADER_TEXT" \
            | tr '[:upper:]' '[:lower:]' \
            | sed -E 's/[^a-z0-9]+/-/g' \
            | sed -E 's/^-+|-+$//g')
          TOC_LINES+=("- [$HEADER_TEXT](#$ANCHOR)")
        done < <(grep -E '^(#{1,6})\s' "$README_FILE" | grep -vE '^\.\S+|附件')

        # 分离 README.md 原内容
        CONTENT_BEFORE_TOC=$(sed -n '/<!-- TOC -->/q;p' "$README_FILE")
        CONTENT_AFTER_TOC=$(sed -n '/<!-- TOC -->/,$p' "$README_FILE" | tail -n +2)

        # 用 printf 拼接真正的换行
        {
          printf "%s\n" "$CONTENT_BEFORE_TOC"
          for toc_line in "${TOC_LINES[@]}"; do
            printf "%s\n" "$toc_line"
          done
          printf "\n%s\n" "$CONTENT_AFTER_TOC"
        } > "$README_FILE"

    - name: Commit changes to README.md
      uses: EndBug/add-and-commit@v7
      with:
        author_name: "GitHub Actions"
        author_email: "actions@github.com"
        message: "Update Table of Contents in README.md"
