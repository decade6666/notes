name: Generate Table of Contents

on:
  workflow_dispatch:
  schedule:
    # 每天北京时间 05:00 (UTC 21:00)
    - cron: '0 21 * * *'

jobs:
  update-toc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Generate and Update TOC
        run: |
          python3 -c "
          import os
          import re

          def generate_tree(path, prefix=''):
              # 排除不需要显示的文件夹
              exclude = {'.git', '.github', 'images', 'assets', 'node_modules', '.vscode'}
              
              # 获取当前目录下的文件夹和.md文件
              entries = []
              try:
                  all_items = sorted(os.listdir(path))
              except:
                  return []

              for item in all_items:
                  if item in exclude or item.startswith('.'):
                      continue
                  full_path = os.path.join(path, item)
                  if os.path.isdir(full_path):
                      # 检查目录内是否有内容
                      entries.append(item)
                  elif item.endswith('.md') and item.lower() != 'readme.md':
                      entries.append(item)

              tree = []
              for i, entry in enumerate(entries):
                  is_last = (i == len(entries) - 1)
                  connector = '└── ' if is_last else '├── '
                  
                  full_path = os.path.join(path, entry)
                  if os.path.isdir(full_path):
                      # 添加目录名
                      tree.append(f'{prefix}{connector}{entry}/')
                      # 递归处理子目录
                      new_prefix = prefix + ('    ' if is_last else '│   ')
                      tree.extend(generate_tree(full_path, new_prefix))
                  else:
                      # 添加文件名
                      tree.append(f'{prefix}{connector}{entry}')
              return tree

          # 获取仓库名作为根目录（这里写死为 notes/ 符合你的要求）
          root_name = 'notes/'
          tree_lines = [root_name] + generate_tree('.')
          toc_content = '```\n' + '\n'.join(tree_lines) + '\n```'

          # 更新 README
          readme_path = 'README.md'
          if os.path.exists(readme_path):
              with open(readme_path, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              start_marker = '<!-- TOC_START -->'
              end_marker = '<!-- TOC_END -->'
              pattern = f'{start_marker}.*?{end_marker}'
              replacement = f'{start_marker}\n{toc_content}\n{end_marker}'
              
              if re.search(pattern, content, re.DOTALL):
                  new_content = re.sub(pattern, replacement, content, flags=re.DOTALL)
                  with open(readme_path, 'w', encoding='utf-8') as f:
                      f.write(new_content)
                  print('Tree TOC updated successfully.')
              else:
                  print('Error: Markers not found in README.md')
                  exit(1)
          "

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: update directory tree structure"
            git push
          fi
