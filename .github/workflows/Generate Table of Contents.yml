name: Generate Table of Contents

on:
  workflow_dispatch:        # 手动运行
  schedule:
    - cron: '0 21 * * *'    # UTC 21:00 = UTC+8 05:00

jobs:
  generate-toc:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Build TOC and update README.md
      shell: bash
      run: |
        set -euo pipefail

        README="README.md"
        PLACEHOLDER="<!-- TOC -->"

        # Add placeholder if missing
        if ! grep -q "$PLACEHOLDER" "$README"; then
          echo "$PLACEHOLDER" >> "$README"
        fi

        # Build TOC lines
        TOC=()
        while IFS= read -r H; do
          TEXT="$(printf "%s" "$H" | sed -E 's/^(#{1,6})[[:space:]]+(.*)/\2/')"
          ANCHOR="$(printf "%s" "$TEXT" \
            | tr '[:upper:]' '[:lower:]' \
            | sed -E 's/[^a-z0-9]+/-/g; s/^-+//; s/-+$//')"
          TOC+=("- [$TEXT](#$ANCHOR)")
        done < <(grep -E '^(#{1,6})\s' "$README" | grep -vE '^\.\S+|附件')

        # Split README sections
        BEFORE="$(sed -n "/$PLACEHOLDER/ q; p" "$README")"
        AFTER="$(sed -n "/$PLACEHOLDER/,\$p" "$README" | tail -n +2)"

        # Rewrite file with exactly ONE trailing newline
        {
          printf "%s\n" "$BEFORE"
          for line in "${TOC[@]}"; do
            printf "%s\n" "$line"
          done
          # Ensures no extra blank lines are added at EOF
          printf "%s" "$AFTER" \
            | sed -e ':a; /.*\n$/!{N; b a}' -e 's/\n\+\z/\n/'
        } > "$README"

    - name: Commit changes if needed
      run: |
        set -euo pipefail
        if git diff --quiet -- README.md; then
          echo "No change"
          exit 0
        fi
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add README.md
        git commit -m "Update Table of Contents in README.md"
        git push
