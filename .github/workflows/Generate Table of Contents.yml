name: Generate Table of Contents

on:
  workflow_dispatch:
  schedule:
    # 每天北京时间 05:00 (UTC 21:00)
    - cron: '0 21 * * *'

jobs:
  update-toc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Generate and Update TOC
        run: |
          python3 -c "
          import os
          import re

          def get_tree(path, prefix=''):
              # 排除不需要的目录
              exclude = {'.git', '.github', 'images', 'assets', 'node_modules', '.vscode', 'venv'}
              try:
                  items = sorted(os.listdir(path))
              except:
                  return []

              # 过滤出目录和.md文件（排除README本身）
              valid_items = [i for i in items if i not in exclude and not i.startswith('.') and 
                             (os.path.isdir(os.path.join(path, i)) or (i.endswith('.md') and i.lower() != 'readme.md'))]

              tree_lines = []
              for i, item in enumerate(valid_items):
                  is_last = (i == len(valid_items) - 1)
                  connector = '└── ' if is_last else '├── '
                  full_path = os.path.join(path, item)
                  
                  if os.path.isdir(full_path):
                      tree_lines.append(f'{prefix}{connector}{item}/')
                      new_prefix = prefix + ('    ' if is_last else '│   ')
                      tree_lines.extend(get_tree(full_path, new_prefix))
                  else:
                      tree_lines.append(f'{prefix}{connector}{item}')
              return tree_lines

          # 1. 生成树状结构块
          tree_content = ['notes/'] + get_tree('.')
          toc_block = '```\n' + '\n'.join(tree_content) + '\n```'

          # 2. 读取并清洗 README
          readme_path = 'README.md'
          start_marker = '<!-- TOC_START -->'
          end_marker = '<!-- TOC_END -->'
          
          if os.path.exists(readme_path):
              with open(readme_path, 'r', encoding='utf-8') as f:
                  content = f.read()

              # 寻找标记位置
              if start_marker in content:
                  # 只保留标记之前的内容，丢弃标记之后的所有内容（彻底解决多余内容问题）
                  header = content.split(start_marker)[0].strip()
                  # 重新组装：头部内容 + 目录块 + 标记（标记放在最后）
                  new_content = header + '\n\n' + start_marker + '\n' + toc_block + '\n' + end_marker
              else:
                  # 如果没标记，则直接在原有内容后追加
                  new_content = content.strip() + '\n\n' + start_marker + '\n' + toc_block + '\n' + end_marker
              
              # 3. 写入文件（确保末尾只有一个换行）
              with open(readme_path, 'w', encoding='utf-8') as f:
                  f.write(new_content.strip() + '\n')
              print('TOC updated and junk content removed.')
          "

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          # 只有在有变化时才提交
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: auto update directory tree and clean junk"
            git push
          fi
