name: Generate Table of Contents

on:
  # 手动触发
  workflow_dispatch:
  # 定时触发：每天北京时间 05:00 (UTC 21:00)
  schedule:
    - cron: '0 21 * * *'

jobs:
  update-toc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # 确保有权限推送代码
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Generate and Update TOC
        run: |
          python3 -c "
          import os
          import re
          from pathlib import Path

          def get_toc(path, level=0):
              items = []
              # 排除不需要扫描的文件夹
              exclude = {'.git', '.github', 'images', 'assets', 'node_modules', 'venv'}
              
              try:
                  # 获取并排序，文件夹排在文件前面，按字母顺序
                  entries = sorted(os.listdir(path))
              except:
                  return ''

              for entry in entries:
                  if entry in exclude or entry.startswith('.'):
                      continue
                  
                  full_path = os.path.join(path, entry)
                  # 核心修复：使用 pathlib 的 as_posix() 避开反斜杠转义报错
                  rel_path_obj = Path(full_path).relative_to('.')
                  url_path = rel_path_obj.as_posix()
                  
                  if os.path.isdir(full_path):
                      items.append('  ' * level + f'- [{entry}](./{url_path})')
                      # 递归获取子目录
                      sub_items = get_toc(full_path, level + 1)
                      if sub_items:
                          items.append(sub_items)
                  elif entry.endswith('.md') and entry.lower() != 'readme.md':
                      name = entry[:-3]
                      items.append('  ' * level + f'- [{name}](./{url_path})')
              
              return '\n'.join([i for i in items if i])

          toc_content = get_toc('.')
          
          readme_path = 'README.md'
          if os.path.exists(readme_path):
              with open(readme_path, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              # 标记锚点
              start_marker = '<!-- TOC_START -->'
              end_marker = '<!-- TOC_END -->'
              pattern = f'{start_marker}.*?{end_marker}'
              replacement = f'{start_marker}\n\n{toc_content}\n\n{end_marker}'
              
              # 检查是否存在标记，存在则替换，不存在则报错
              if re.search(pattern, content, re.DOTALL):
                  new_content = re.sub(pattern, replacement, content, flags=re.DOTALL)
                  with open(readme_path, 'w', encoding='utf-8') as f:
                      f.write(new_content)
                  print('TOC generated and markers updated.')
              else:
                  print('Error: README.md is missing <!-- TOC_START --> or <!-- TOC_END --> markers.')
                  exit(1)
          else:
              print('Error: README.md not found.')
              exit(1)
          "

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          # 检查是否有文件变更，防止空 commit 导致报错
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: auto update table of contents"
            git push
          fi
