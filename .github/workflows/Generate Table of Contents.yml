name: Generate Table of Contents

on:
  workflow_dispatch:        # 手动运行
  schedule:
    - cron: '0 21 * * *'    # UTC 21:00 = UTC+8 05:00

jobs:
  generate-toc:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build TOC and update README.md
      shell: bash
      run: |
        set -euo pipefail

        README="README.md"
        PLACEHOLDER="<!-- TOC -->"

        # 加上占位符（如果没有）
        if ! grep -q "$PLACEHOLDER" "$README"; then
          echo "$PLACEHOLDER" >> "$README"
        fi

        # 提取 headings
        TOC_LINES=()
        while IFS= read -r H; do
          HEAD=$(printf "%s" "$H" | sed -E 's/^(#{1,6})[[:space:]]+(.*)/\2/')
          ANCHOR=$(printf "%s" "$HEAD" \
            | tr '[:upper:]' '[:lower:]' \
            | sed -E 's/[^a-z0-9]+/-/g; s/^-+//; s/-+$//')
          TOC_LINES+=("- [$HEAD](#$ANCHOR)")
        done < <(grep -E '^(#{1,6})[[:space:]]+' "$README" \
                  | grep -vE '^\.\S+|附件')

        # 分割文件
        BEFORE=$(sed -n "/$PLACEHOLDER/ q; p" "$README")
        AFTER=$(sed -n "/$PLACEHOLDER/,\$p" "$README" | tail -n +2)

        # 写回
        {
          printf "%s\n" "$BEFORE"
          for LINE in "${TOC_LINES[@]}"; do
            printf "%s\n" "$LINE"
          done
          # 必须：EOF 只留一个换行
          printf "%s" "$AFTER" | sed -e '$!b' -e '/^$/d'
          printf "\n"
        } > "$README"

    - name: Commit changes if needed
      shell: bash
      run: |
        set -euo pipefail
        if git diff --quiet -- README.md; then
          echo "No changes, skipping commit."
          exit 0
        fi
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add README.md
        git commit -m "Update Table of Contents in README.md"
        git push
