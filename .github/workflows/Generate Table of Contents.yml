name: Generate Table of Contents

on:
  push:
    paths:
      - '**/*.md'
      - README.md
  pull_request:
    paths:
      - '**/*.md'
      - README.md
  workflow_dispatch:  # 支持手动触发
  schedule:
    - cron: '0 21 * * *'  # 每天 05:00 AM UTC+8（21:00 UTC）

jobs:
  generate-toc:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Generate Table of Contents for README.md
      run: |
        #!/bin/bash
        README_FILE="README.md"

        TOC_PLACEHOLDER="<!-- TOC -->"
        if ! grep -q "$TOC_PLACEHOLDER" "$README_FILE"; then
          echo "$TOC_PLACEHOLDER" >> "$README_FILE"
        fi

        # 生成 TOC（忽略以 . 开头和 “附件” 文件夹内）
        TOC=()
        while IFS= read -r line; do
          # Get the header text and anchor link
          HEADER_TEXT=$(echo "$line" | sed -E 's/^(#{1,6})\s(.*)/\2/')
          ANCHOR=$(echo "$HEADER_TEXT" \
            | tr '[:upper:]' '[:lower:]' \
            | sed -E 's/[^a-z0-9]+/-/g' \
            | sed -E 's/^-+|-+$//g')
          
          # 过滤掉不需要的部分，如 'notes' 和 '文件目录'
          if [[ ! "$HEADER_TEXT" =~ "notes" && ! "$HEADER_TEXT" =~ "文件目录" ]]; then
            TOC+=("- [$HEADER_TEXT](#$ANCHOR)")
          fi
        done < <(grep -E '^(#{1,6})\s' "$README_FILE" | grep -vE '^\.\S+|附件')

        # 分离 README.md 中的 TOC 部分和其他内容
        CONTENT_BEFORE_TOC=$(sed -n '/<!-- TOC -->/q;p' "$README_FILE")
        CONTENT_AFTER_TOC=$(sed -n '/<!-- TOC -->/,$p' "$README_FILE" | tail -n +2)

        # 使用 printf 输出新的 TOC 内容
        {
          printf "%s\n" "$CONTENT_BEFORE_TOC"   # 保留 TOC 占位符前的内容
          for toc_line in "${TOC[@]}"; do       # 插入新生成的 TOC
            printf "%s\n" "$toc_line"
          done
          printf "\n%s\n" "$CONTENT_AFTER_TOC"  # 保留 TOC 占位符后的内容
        } > "$README_FILE"

    - name: Commit changes to README.md
      uses: EndBug/add-and-commit@v7
      with:
        author_name: "GitHub Actions"
        author_email: "actions@github.com"
        message: "Update Table of Contents in README.md"
