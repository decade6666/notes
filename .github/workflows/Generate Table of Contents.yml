name: Generate Table of Contents

on:
  workflow_dispatch:  # 手动触发
schedule:
- cron: '0 21 * * *'  # 每天 05:00 AM UTC+8（21:00 UTC）

@@ -27,42 +19,50 @@ jobs:
       README_FILE="README.md"
       TOC_PLACEHOLDER="<!-- TOC -->"

        # Ensure placeholder exists
       if ! grep -q "$TOC_PLACEHOLDER" "$README_FILE"; then
          printf "\n%s\n" "$TOC_PLACEHOLDER" >> "$README_FILE"
       fi

        # Build TOC from headings in README (ignore dot-start lines and '附件')
        TOC_LINES=()
       while IFS= read -r line; do
          HEADER_TEXT="$(printf "%s" "$line" | sed -E 's/^(#{1,6})[[:space:]]+(.*)/\2/')"

          # GitHub-ish anchor (basic)
          ANCHOR="$(printf "%s" "$HEADER_TEXT" \
           | tr '[:upper:]' '[:lower:]' \
            | sed -E 's/[^a-z0-9]+/-/g; s/^-+//; s/-+$//')"

          TOC_LINES+=("- [$HEADER_TEXT](#$ANCHOR)")
        done < <(grep -E '^(#{1,6})[[:space:]]+' "$README_FILE" | grep -vE '^\.\S+|附件')

        # Split original content
        CONTENT_BEFORE_TOC="$(sed -n '/<!-- TOC -->/q;p' "$README_FILE")"
        CONTENT_AFTER_TOC="$(sed -n '/<!-- TOC -->/,$p' "$README_FILE" | tail -n +2)"

        # Write back (no extra blank lines at EOF)
       {
          printf "%s\n" "$CONTENT_BEFORE_TOC"
          for toc_line in "${TOC_LINES[@]}"; do
           printf "%s\n" "$toc_line"
         done
          printf "%s" "$CONTENT_AFTER_TOC"
       } > "$README_FILE"

        # Collapse trailing newlines to exactly ONE newline at EOF (fix "+1 line" issue)
        perl -0777 -i -pe 's/\n+\z/\n/' "$README_FILE"

    - name: Commit changes to README.md (only if changed)
      shell: bash
      run: |
        set -euo pipefail
        if git diff --quiet -- README.md; then
          echo "README.md unchanged, skip commit."
          exit 0
        fi
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add README.md
        git commit -m "Update Table of Contents in README.md"
        git push
